<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Ayham's online website"><meta name=keywords content="ayham,personal,blog,linux"><meta name=author content="ayham"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light"><link rel=icon type=image/x-icon href=https://ayham.xyz/pix/avatar/pfp_hu_9b8ef136499e5f25.260c87cca6a67382a9043e12d7bf4dae.png integrity="md5-JgyHzKamc4KpBD4S179Nrg==" crossorigin=anonymous><link rel=stylesheet type=text/css href=https://ayham.xyz/css/nav.dbcff7b67f99ee271630f11e6d609150.css integrity="md5-28/3tn+Z7icWMPEebWCRUA==" crossorigin=anonymous><link rel=stylesheet type=text/css href=https://ayham.xyz/css/footer.e71d515740d85272dc5a068dedc6394b.css integrity="md5-5x1RV0DYUnLcWgaN7cY5Sw==" crossorigin=anonymous><link rel=stylesheet type=text/css href=https://ayham.xyz/css/common.4d89642363d46c847439f85578bb0cf0.css integrity="md5-TYlkI2PUbIR0OfhVeLsM8A==" crossorigin=anonymous><title>Ayham's Online Website | Hardening the Archlinux WiFi Network Stack</title></head><body><center><nav><ul><li><a href=/>[Home]</a></li><li><a href=/projects/>[Projects]</a></li><li><a href=/posts/>[Posts]</a></li><li><a href=/library/>[Library]</a></li><li><a href=/apps/>[Apps]</a></li></ul></nav><hr></center><main><center><h1>Hardening the Archlinux WiFi Network Stack</h1></center>Publish Date: <time datetime=2024-04-21>Apr 21, 2024</time>&nbspLast Update: <time datetime=2024-06-24>Jun 24, 2024</time><br>Tags:<a href=https://ayham.xyz/tags/guide>guide</a>
<a href=https://ayham.xyz/tags/security>security</a>
<a href=https://ayham.xyz/tags/archlinux>archlinux</a><br>422 words, 2 minute(s) to read.<br><br><article><p>A wise Archlinux user once said:</p><pre tabindex=0><code class=language-quote data-lang=quote>One shall secure his network stack, or shall suffer network leaks.
- a wise internet enjoyer
</code></pre><p>Due to ArchLinux&rsquo;s design of customizability and Laissez-Faire-like package and
system architecture policies, one has to make the incomprehnsibly (indeed)
difficult choice of choosing his network stack. Generally speaking, a decent
choice for estabilishing WiFi connection, is using <code>iwd</code>. And <code>dhcpcd</code> for ethernet.
In this article, I would be focusing on WiFi and DNS hardening. More specifically,
these are the areas where slight changes to the configuration would offer a more
secure network stack:</p><ul><li>Automatic full/half MAC-address octets randomization on every network connection.</li><li>System-wide DNS resolving over TLS</li><li>DNSSEC signature verification</li></ul><p>A &lsquo;downside&rsquo; of such configuration scheme is that public routers, which have
login pages, need you to have DNS-over-TLS disabled for rerouting. However, it
is not that hard to do so.</p><p><em>Note: this guide assumes you already have WiFi configured using <code>iwd</code></em></p><h2 id=configuring-iwd-for-automatic-mac-address-randomization>Configuring <code>IWD</code> for Automatic MAC-Address Randomization</h2><p>In <code>/etc/iwd/main.conf</code> have the following configured:</p><div class=highlight><div style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[General]
</span></span><span style=display:flex><span><span style=color:#40ffff>EnableNetworkConfiguration</span>=<span style=color:#24909d>true</span>
</span></span><span style=display:flex><span><span style=color:#40ffff>NameResolvingService</span>=systemd
</span></span><span style=display:flex><span><span style=color:#40ffff>AutoConnect</span>=<span style=color:#24909d>true</span>
</span></span><span style=display:flex><span><span style=color:#40ffff>AddressRandomization</span>=network
</span></span><span style=display:flex><span><span style=color:#40ffff>AddressRandomizationRange</span>=nic
</span></span><span style=display:flex><span><span style=color:#40ffff>AlwaysRandomizeAddress</span>=<span style=color:#24909d>true</span>
</span></span></code></pre></td></tr></table></div></div><p>If you would like to have complete address randomization, set
<code>AddressRandomizationRange</code> to <code>full</code>. <code>nic</code> means that only last 3 octets are
randomized. This <em>could</em> help with avoiding immediate detection of MAC address
randomization on the network, as the first three octets are normally used as
manufacturer identification.</p><h2 id=configuring-systemd-resolve>Configuring <code>systemd-resolve</code></h2><p>Enable the service:</p><div class=highlight><div style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl <span style=color:#24909d>enable</span> systemd-resolved
</span></span><span style=display:flex><span>sudo systemctl start systemd-resolved
</span></span></code></pre></td></tr></table></div></div><p>Configure usage of local systemd DNS server for application that
<dev><a href=https://wiki.archlinux.org/title/Systemd-resolved#DNS target=_blank>use glibc&rsquo;s
<code>getaddrinfo()</code></a><span class=externalLink>ðŸ”—</span>
</dev>.</p><div class=highlight><div style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ln -sf ../run/systemd/resolve/stub-resolv.conf /etc/resolv.conf
</span></span></code></pre></td></tr></table></div></div><p>In the file <code>/etc/systemd/resolved.conf</code> have:</p><div class=highlight><div style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[Resolve]
</span></span><span style=display:flex><span><span style=color:#40ffff>DNS</span>=9.9.9.9#dns.quad9.net 149.112.112.112#dns.quad9.net 2620:fe::fe#dns.quad9.net 2620:fe::9#dns.quad9.net
</span></span><span style=display:flex><span><span style=color:#40ffff>FallbackDNS</span>=9.9.9.9#dns.quad9.net 149.112.112.112#dns.quad9.net 2620:fe::fe#dns.quad9.net 2620:fe::9#dns.quad9.net
</span></span><span style=display:flex><span><span style=color:#40ffff>DNSSEC</span>=yes
</span></span><span style=display:flex><span><span style=color:#40ffff>DNSOverTLS</span>=yes
</span></span><span style=display:flex><span><span style=color:#40ffff>Cache</span>=yes
</span></span><span style=display:flex><span><span style=color:#40ffff>DNSStubListener</span>=yes
</span></span><span style=display:flex><span><span style=color:#40ffff>DNSStubListenerExtra</span>=udp:127.0.0.1:53
</span></span></code></pre></td></tr></table></div></div><p>This tells <code>systemd-resolved</code> to use quad9 as remote DNS server, feel free to
replace <code>DNS</code> and <code>FallbackDNS</code> values with whatever server suites you.</p><h2 id=accessing-public-wifi>Accessing Public WiFi</h2><p>Most public WiFi requires you accepting an agreement (yuck) or signing in. If
you&rsquo;ve followed the previous instructions, this means that you won&rsquo;t be able to
resolve the redirect which WiFi routers use in order to redirect you from any
website you access to their own website. However, you can temporarily disable
secure DNS and use a browser that does not verify DNS signatures. Through testing,
found out that Brave (chromium based) allows such redirects while Firefox does not.</p><p>To disable systemd resolving temporarily, change in <code>/etc/systemd/resolved.conf</code>:</p><div class=highlight><div style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[Resolve]
</span></span><span style=display:flex><span><span style=color:#40ffff>DNSSEC</span>=no
</span></span><span style=display:flex><span><span style=color:#40ffff>DNSOverTLS</span>=no
</span></span></code></pre></td></tr></table></div></div><p>Don&rsquo;t forget to turn them back on once logged in to the network.</p><p>Enjoy!</p></article></main><hr><footer><center><div class=footerTable><div style=display:block><p>Unique Visitors:
<a href=https://www.digits.net target=_blank rel=noopener><img src="https://counter.digits.net/?counter={f115c91c-b3dd-7584-456b-e7a9e52faa74}&template=simple" alt="Hit Counter by Digits" border=0></a></p><p><a href=https://ayham.xyz><img width=88 height=31 src=https://ayham.xyz/pix/webpins/ayhamxyz.6d7f8c95fb6135a73680ad01aa3b523e.gif crossorigin=anonymous integrity="md5-bX+MlfthNac2gK0BqjtSPg==" alt="ayham.xyz webpin"></a></p><p>Last Edited On: 2025-06-17</p></div><div style=display:block><small>CC-BY-SA - 2025</small><br><small><a href=/index.xml>Subscribe via RSS.</a></small><br><small><a href=https://ayham.xyz/details/>Website Details.</a></small>
<script data-goatcounter=https://ayham.goatcounter.com/count async src=//gc.zgo.at/count.js></script></div></div><center></footer></body></html>